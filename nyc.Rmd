---
title: "nyc"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(janitor)
library(skimr)
library(infer)
library(readxl)
library(stringr)
library(tidyr)
```

```{r}
# Read in main data set

data <- read.csv("raw/schma19962016.csv") %>% 
  clean_names()

addon <- read_csv("raw/stchso20052016.csv") %>% 
  clean_names()

#Load in collected data about new and failing schools
old_new_schools <- read_excel("raw/oldnewssc.xlsx")

# Create a list of schools so that I can see how they are named in this data

schools <- data %>% 
  select(schnam) %>% 
  distinct(schnam) %>% 
  arrange(schnam)

# Create a list of NYC's specialized schools

selective_schools <- c("BRONX HIGH SCHOOL OF SCIENCE", "BROOKLYN TECHNICAL HIGH SCHOOL", "STATEN ISLAND TECHNICAL HS", "STUYVESANT HIGH SCHOOL", "BROOKLYN LATIN, THE", "QUEENS HIGH SCHOOL FOR THE SCIENCES AT YORK COLLEG", "HIGH SCHOOL FOR MATHEMATICS, SCIENCE AND ENGINEERI", "HIGH SCHOOL OF AMERICAN STUDIES AT LEHMAN COLLEGE")

# Create a dataset that filters out observations for selective schools

data_selective_schools <- data %>% 
  filter(schnam %in% selective_schools)

```

```{r Load in and clean enrollment data 2006-2015, echo = FALSE}

#Load in 2006-2012 and filter for high schools
#Schoolyear was in 20xx20xx format, so I deleted first four digits
#Had to convert to character form to do that
#Filtered for grades 9-12 that were not NA count

demo_20062012 <- read_csv("raw/enrollmentdata/2006_-_2012_School_Demographics_and_Accountability_Snapshot.csv") %>% 
  clean_names() %>% 
  mutate(schoolyear = as.character(schoolyear),
         schoolyear = gsub('^.{4}', '', schoolyear),
         schoolyear = as.numeric(schoolyear)) %>% 
  filter(!is.na(grade9) & !is.na(grade10) & !is.na(grade11) &!is.na(grade12)) %>% 
  mutate(total_hs_enrollment = grade9 + grade10 + grade11 + grade12)

demo_20062012

#Load in 2011-2016 and filter for high schools
#Schoolyear was in 20xx-xx format so got rid of middle "x-x"
#Filtered for grades 9-12 that were not 0 count
#Coerce all character columns into numeric (get rid of '%' first)
demo_20112016 <- read_csv("raw/enrollmentdata/2011_-_2016_Demographic_Snapshot.csv") %>% 
  clean_names() %>% 
  mutate(year = str_replace(year, pattern = "\\d[:punct:]\\d", replacement = ""),
         year = as.numeric(year)) %>% 
  filter(grade_9 != 0 & grade_10 != 0 & grade_11 != 0 & grade_12 != 0) %>% 
  mutate(total_hs_enrollment = grade_9 + grade_10 + grade_11 + grade_12,
         percent_asian = as.numeric(sub("%", "", percent_asian)),
         percent_hispanic = as.numeric(sub("%", "", percent_hispanic)),
         percent_black = as.numeric(sub("%", "", percent_black)),
         percent_white = as.numeric(sub("%", "", percent_white)),
         percent_female = as.numeric(sub("%", "", percent_female)),
         percent_male = as.numeric(sub("%", "", percent_male)),
         percent_other = as.numeric(sub("%", "", percent_other)),
         percent_english_language_learners = as.numeric(sub("%", "", percent_english_language_learners)),
         percent_poverty = as.numeric(sub("%", "", percent_poverty)),
         percent_students_with_disabilities = as.numeric(sub("%", "", percent_students_with_disabilities))
         ) 

#Combined both data sets and combineed overlapping columns 
#Demographic data per school from 2006-2016
#Include only high school #s
demo_20062016 <- demo_20062012 %>% 
  filter(schoolyear != 2012) %>% 
  full_join(demo_20112016, by = c("dbn", 
                                  "schoolyear" = "year",
                                  "total_enrollment",
                                  "total_hs_enrollment",
                                  "prek" = "grade_pk",
                                  "k"= "grade_k",
                                  "grade1" = "grade_1",
                                  "grade2" = "grade_2",
                                  "grade3" = "grade_3",
                                  "grade4" = "grade_4",
                                  "grade5" = "grade_5",
                                  "grade6" = "grade_6",
                                  "grade7" = "grade_7",
                                  "grade8" = "grade_8",
                                  "grade9" = "grade_9",
                                  "grade10" = "grade_10",
                                  "grade11" = "grade_11",
                                  "grade12" = "grade_12",
                                  "name" = "school_name",
                                  "asian_num" = "number_asian",
                                  "asian_per" = "percent_asian",
                                  "black_num" = "number_black",
                                  "black_per" = "percent_black", 
                                  "hispanic_num" = "number_hispanic",
                                  "hispanic_per" = "percent_hispanic", 
                                  "white_num" = "number_white",
                                  "white_per"= "percent_white",
                                  "female_num" = "number_female",
                                  "male_num" = "number_female",
                                  "ell_num" = "number_english_language_learners",
                                  "ell_percent" = "percent_english_language_learners",
                                  "frl_percent" = "percent_poverty"
                                  )) %>% 
  mutate(fl_or_frl_lunch = coalesce(frl_percent, fl_percent)) %>% 
  select(-prek, -k, -grade1, -grade2, -grade3, -grade4, -grade5, -grade6, -grade7, -grade8) %>% 
  arrange(dbn, schoolyear) 


# Commented code for loading in 2013-2018 data
#demo_20132018 <- read_csv("raw/enrollmentdata/2013_-_2018_Demographic_Snapshot_School.csv") %>% 
#  clean_names() %>% 
#  mutate(year = str_replace(year, pattern = "\\d[:punct:]\\d", replacement = ""),
#         year = as.numeric(year)) %>% 
# filter(grade_9 != 0 & grade_10 != 0 & grade_11 != 0 & grade_12 != 0) %>% 
#  mutate(total_hs_enrollment = grade_9 + grade_10 + grade_11 + grade_12)

#demo_20132018 

```


```{r Graduation Rates Cutoff Comparison}

# Filter for high schools (defined as schools serving 9-12 at least)  

data_hs <- data %>% 
  filter(enrnumg12 != 0 & enrnumg11 != 0 & enrnumg10  != 0 & enrnumg09 != 0 ) %>% 
  group_by(year) %>% 
  mutate(percent_rank = percent_rank(hsopcthsgtot))

# Plot all schools by year and graduation rates

data_hs %>% 
  filter(hsopcthsgtot != is.na(hsopcthsgtot)) %>% 
  select(schnam, year, hsopcthsgtot) %>% 
  ggplot(aes(x = year, y = hsopcthsgtot, color = schnam)) + 
  geom_jitter() +
  theme(legend.position = "none")

# Plot percentile rank of school over time

data_hs %>% 
  filter(schnam %in% selective_schools) %>% 
  ggplot(aes(x= year, y = percent_rank, color = schnam)) +
  geom_line() +
  theme(legend.position = "none")

# Find out valid observations of graduation rates per year

data %>% 
  group_by(year) %>% 
  filter(hsopctdchtot != is.na(hsopcthsgtot)) %>% 
  select(schnam, year, hsopcthsgtot) %>% 
  count()

```


```{r grad_rates_clean (From grad rates 2005-2010), echo = FALSE}
#Load in 2005-15 graduation rate data and clean variable names
grad_rates_20052015 <- read_excel("raw/graduationrates/2005-2015_Graduation_Rates_Public_School.xlsx") %>% 
  clean_names() 

# Clean the data so that it only contains observations of graduation classes for 4 Year August (or 4 Year June if August is not available)
grad_rates_clean <- grad_rates_20052015 %>% 
  filter(str_detect(cohort_category,"4 Year"), 
         demographic == "English Language Proficient") %>% 
  mutate(grad_year = cohort_year + 4)

grad_rates_clean$cohort_category <- factor(grad_rates_clean$cohort_category, levels = c("4 Year August", "4 Year  June"))

grad_rates_clean <- grad_rates_clean[order(grad_rates_clean$cohort_category),]

grad_rates_clean <- grad_rates_clean[!duplicated(grad_rates_clean[,c('dbn', 'cohort_year')]),]


grad_rates_clean <- grad_rates_clean %>% 
  group_by(dbn) %>% 
  arrange(cohort_year, .by_group = TRUE)

# Filter only for non "s" values of graduation percentage
# Turn Graduation percentage from chr to dbl
grad_rates_clean <- grad_rates_clean %>% 
  filter(total_grads_percent_of_cohort != "s") %>% 
  mutate(total_grads_percent_of_cohort = as.double(total_grads_percent_of_cohort),
         total_regents_percent_of_cohort = as.double(total_regents_percent_of_cohort),
         total_regents_percent_of_grads = as.double(total_regents_percent_of_grads),
         advanced_regents_percent_of_cohort = as.double(advanced_regents_percent_of_cohort),
         advanced_regents_percent_of_grads = as.double(advanced_regents_percent_of_grads))
  

# Plot 
# Must manually get rid of y labels and ticks or else it looks terrible

grad_rates_clean %>% 
  select(dbn, cohort_year, total_grads_percent_of_cohort) %>% 
  filter(total_grads_percent_of_cohort != "s") %>% 
  ggplot(aes(x = cohort_year, y = total_grads_percent_of_cohort, color = dbn)) +
  geom_point() +
  theme_classic() + 
  theme(legend.position = "none",
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```

```{r Join both data sets (SCHMA + grad-rates2005-2010)}

data_join <- data_hs %>% 
  full_join(grad_rates_clean, by = c("dbn", "year" = "grad_year")) %>% 
  mutate(total_hs_enrollment = enrnumg09 + enrnumg10 + enrnumg11 + enrnumg12)

```


```{r SSC analysis, echo = FALSE}

# Pull a list of the large failing schools that housed new replacement schools

large_failing_schools <- old_new_schools %>% 
  select(old_dbn, old_schnam, last_old_year) %>% 
  distinct() %>% 
  pull(old_dbn)

# Pull a list of the small replacement schools 
replacement_schools <- old_new_schools %>% 
  select(new_dbn, new_schnam, first_year_end) %>% 
  pull(new_dbn)


# Graduation rates of large failing schools that were closed

data_hs %>% 
  filter(dbn %in% large_failing_schools) %>% 
  select(dbn,hsopcthsgtot) %>% 
  arrange(dbn) %>% 
  ggplot(aes(x = year, y = hsopcthsgtot, color = dbn)) +
  geom_line()

# Graduation rates of new repalcement schools

data_hs %>% 
  filter(dbn %in% replacement_schools) %>% 
  ggplot(aes(x = year, y = hsopcthsgtot, color = dbn)) +
  geom_line()

#Join the old new schools data table to the clean grad rates so I can see the
#stats of all new schools and identified by old high school
grad_rates_clean_append <- grad_rates_clean %>% 
  filter(dbn %in% replacement_schools) %>% 
  left_join(old_new_schools, by = c("dbn" = "new_dbn")) %>% 
  filter(!is.na(old_dbn))


# Plot average graduation rates of new replacement schools organized by their former
# large school
grad_rates_clean_append %>% 
  group_by(old_dbn, cohort_year) %>% 
  summarize(mean_new_dbn = mean(total_grads_percent_of_cohort)) %>% 
  ggplot(aes(x = cohort_year + 4, y = mean_new_dbn, color = old_dbn)) +
  geom_line()

# Plot graduation rates of new replacements schools 

grad_rates_clean %>% 
  filter(dbn %in% old_new_schools$new_dbn) %>% 
  ggplot(aes(x = cohort_year + 4, y = total_grads_percent_of_cohort, color = dbn)) + 
  geom_line() +
  theme(legend.position = "none")
  

```

```{r Find comparable schools that werent closed, echo = FALSE}

# Explore data: Compare graduation metrics between the two data sets, organized by school across years
# Seems like total_grads_percent_of_cohort is more in line with hsopcthsgnyc
# Almost all schools have observations from 2005- we'll use that as a starting point
  
graduation_rates_failing_closed_joined <- data_join %>% 
  filter(dbn %in% old_new_schools$old_dbn) %>% 
  select(dbn, school, year, total_grads_percent_of_cohort, hsopcthsgtot, hsopcthsgnyc) %>% 
  group_by(dbn) %>% 
  nest()

#Find graduation rates of schools in the middle 80th percentile (excluded tail ends to exclude outliers)

close_school_2005_graduation_rates <- data_join %>% 
  filter(year == 2005, 
         dbn %in% old_new_schools$old_dbn) %>% 
  select(dbn, schnam, school, total_grads_percent_of_cohort,hsopcthsgtot, hsopcthsgnyc) %>% 
  summarize(percentile_10 = quantile(as.numeric(total_grads_percent_of_cohort), 
                                     probs = 0.1, 
                                     na.rm = TRUE),
            percentile_90 = quantile(as.numeric(total_grads_percent_of_cohort),
                                     probs = 0.9, 
                                     na.rm = TRUE),
            percentile_50 = quantile(as.numeric(total_grads_percent_of_cohort),
                                     probs = 0.5, 
                                     na.rm = TRUE))

closed_10_grad <- close_school_2005_graduation_rates %>% 
  pull(percentile_10)

closed_50_grad <- close_school_2005_graduation_rates %>% 
  pull(percentile_50)

closed_90_grad <- close_school_2005_graduation_rates %>% 
  pull(percentile_90)

# 10th percentile :0.2389633206
# 50th percentile: 0.3885992
# 90th percentile: 0.46599

data_failing_open <- data_join %>% 
  
  #select only necessay information (faster processing)
  select(dbn, school, year, total_grads_percent_of_cohort, total_hs_enrollment) %>% 
  
  #exclude NAs and schools that were either replaced or were replacements in '05
  filter(!is.na(total_grads_percent_of_cohort),
         !dbn %in% old_new_schools$old_dbn &
         !dbn %in% old_new_schools$new_dbn) %>% 
  group_by(dbn) %>% 
  nest() %>% 
  
  #create column that indicates if there is data from 05-15
  mutate("avail20052015" = map_lgl(data, ~ifelse(2015 %in% .[[2]] & 2005 %in% .[[2]], 
                        TRUE,
                        FALSE))) %>% 
  
  # Create column that indicates it there is data from 2005
  mutate("avail2005" = map_lgl(data, ~ifelse(2005 %in% .[[2]], 
                        TRUE,
                        FALSE))) %>% 
  
  # Filter for schools where there is available data from 2005
  filter(avail2005  == TRUE) %>% 
  
  # Create new column that indicates the graduation rate of school in 2005 
  mutate("grad_2005" = map_dbl(data, ~filter(., year == 2005) %>%           pull(total_grads_percent_of_cohort)),
         
         # Create column indicating if graduation rate falls in the failing schools closed middle 80th percentile
         "grad_rates_fail" = ifelse(grad_2005 <= closed_90_grad &
                                    grad_2005 >= closed_10_grad,
                                    TRUE,
                                    FALSE),
         
         "avg_enrollment" = map_dbl(data, ~mean(.[[4]], na.rm = TRUE))) %>% 
  
  # Filter for schools where graduation rates falls in the failing schools closed middle 80th percentile
  filter(grad_rates_fail == TRUE)
  
# Plot the relationship between high school graduation and enrollment
                  
data_failing_open %>% 
  unnest() %>% 
  ggplot(aes(x = total_hs_enrollment, y = total_grads_percent_of_cohort)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y~x)

```


```{r Compare Graduation Quintiles, echo = FALSE}

# Create dataset that describes 20,50,80 percentiles of graduation per year
grad_rates_nest <- grad_rates_clean %>% 
  group_by(cohort_year) %>% 
  nest() %>% 
  mutate(percentile_20 = map_dbl(data,  ~ quantile(.[[7]], probs = .2)),
         percentile_80 = map_dbl(data,  ~ quantile(.[[7]], probs = .8)),
         percentile_50 = map_dbl(data,  ~ quantile(.[[7]], probs = .5))) %>% 
  arrange(cohort_year) %>% 
  select(-data)

#Graph the median result with errorbars at 80 and 20
grad_rates_nest %>% 
  ggplot(aes(x = cohort_year, y = percentile_50)) +
  geom_point() +
  geom_errorbar(aes(ymin = percentile_20, ymax = percentile_80))

```

```{r Compare Regents Quintiles, echoh = FALSE}
# Create dataset that describes 20,50,80 percentiles of regents/cohort per year
grad_rates_regents_cohort <- grad_rates_clean %>% 
  group_by(cohort_year) %>% 
  nest() %>% 
  mutate(percentile_20 = map_dbl(data,  ~ quantile(.[[9]], probs = .2)),
         percentile_80 = map_dbl(data,  ~ quantile(.[[9]], probs = .8)),
         percentile_50 = map_dbl(data,  ~ quantile(.[[9]], probs = .5))) %>% 
  arrange(cohort_year) %>% 
  select(-data)

#Graph the median result with errorbars at 80 and 20
grad_rates_regents_cohort %>% 
  ggplot(aes(x = cohort_year, y = percentile_50)) +
  geom_point() +
  geom_errorbar(aes(ymin = percentile_20, ymax = percentile_80))


# Create dataset that describes 20,50,80 percentiles of regents/grads per year
grad_rates_regents_grads <- grad_rates_clean %>% 
  group_by(cohort_year) %>% 
  nest() %>% 
  mutate(percentile_20 = map_dbl(data,  ~ quantile(.[[10]], probs = .2, na.rm = TRUE)),
         percentile_80 = map_dbl(data,  ~ quantile(.[[10]], probs = .8, na.rm = TRUE)),
         percentile_50 = map_dbl(data,  ~ quantile(.[[10]], probs = .5, na.rm = TRUE))) %>% 
  arrange(cohort_year) %>% 
  select(-data)

#Graph the median result with errorbars at 80 and 20
grad_rates_regents_grads %>% 
  ggplot(aes(x = cohort_year, y = percentile_50)) +
  geom_point() +
  geom_errorbar(aes(ymin = percentile_20, ymax = percentile_80))


# Create dataset that describes 20,50,80 percentiles of adv regents/cohort
grad_rates_advregents_cohort <- grad_rates_clean %>% 
  group_by(cohort_year) %>% 
  nest() %>% 
  mutate(percentile_20 = map_dbl(data,  ~ quantile(.[[13]], probs = .2, na.rm = TRUE)),
         percentile_80 = map_dbl(data,  ~ quantile(.[[13]], probs = .8, na.rm = TRUE)),
         percentile_50 = map_dbl(data,  ~ quantile(.[[13]], probs = .5, na.rm = TRUE))) %>% 
  arrange(cohort_year) %>% 
  select(-data)

#Graph the median result with errorbars at 80 and 20
grad_rates_advregents_cohort %>% 
  ggplot(aes(x = cohort_year, y = percentile_50)) +
  geom_point() +
  geom_errorbar(aes(ymin = percentile_20, ymax = percentile_80))
```


```{r Count observations per year, echo = FALSE}
# Count observations per year
grad_rates_clean %>% 
  ungroup(dbn, school) %>% 
  group_by(cohort_year) %>% 
  count()


```







